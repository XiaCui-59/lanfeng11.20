(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/call/call"],{"09b8":function(t,e,n){"use strict";n.r(e);var o=n("b544"),a=n.n(o);for(var i in o)["default"].indexOf(i)<0&&function(t){n.d(e,t,(function(){return o[t]}))}(i);e["default"]=a.a},"38fd":function(t,e,n){},7274:function(t,e,n){"use strict";var o=n("38fd"),a=n.n(o);a.a},"8e53":function(t,e,n){"use strict";(function(t,e){var o=n("47a9");n("b833");o(n("3240"));var a=o(n("d637"));t.__webpack_require_UNI_MP_PLUGIN__=n,e(a.default)}).call(this,n("3223")["default"],n("df3c")["createPage"])},b544:function(t,e,n){"use strict";(function(t,o){var a=n("47a9");Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=a(n("7eb4")),r=a(n("7ca3")),c=a(n("ee10")),u=a(n("8d57")),s=n("8f59");function l(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,o)}return n}var d=u.default.urls.voiceUrl,f=getApp(),h={data:function(){return{imgUrl:f.globalData.baseImageUrl,inputStatus:!1,manager:t.getRecorderManager(),lowVoiceCount:0,audioCtx:o.createWebAudioContext(),currentPlayIndex:0,source:null,aiSpeeking:!0,index:0,result:[],tipsText:"请讲，正在听",closeStatus:!1,highVoiceCount:0,longTimeNoInput:!1,action:"audio_call_user_enter"}},onLoad:function(){var t=this;return(0,c.default)(i.default.mark((function e(){return i.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:t.userEnter(),t.initRecord();case 2:case"end":return e.stop()}}),e)})))()},onUnload:function(){this.close()},watch:{lowVoiceCount:function(t){t>30&&(this.highVoiceCount<20&&(this.longTimeNoInput=!0,this.action="audio_call_user_long_time_without_talking"),this.inputStatus=!1,this.manager.stop())},highVoiceCount:function(t){t>20&&(this.longTimeNoInput=!1)},inputStatus:function(t){t&&(this.resetData(),this.startRecord())}},computed:function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?l(Object(n),!0).forEach((function(e){(0,r.default)(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}({},(0,s.mapState)(["answering","connected","connecting","canSend","inChannel","answerContinue","channelQaLen","channelId","channelQaList","location","token"])),methods:{close:function(){this.closeStatus=!0,this.manager.stop(),this.audioCtx&&(this.audioCtx.close(),this.audioCtx=null),t.navigateBack()},interrupt:function(){this.aiSpeeking&&(this.audioCtx.close(),this.resetData())},resetData:function(){this.highVoiceCount=0,this.longTimeNoInput=!1,this.action="",this.lowVoiceCount=0,this.index=0,this.result=[],this.aiSpeeking=!1,this.inputStatus=!0},startRecord:function(){this.manager.start({format:"PCM",sampleRate:8e3,numberOfChannels:2,encodeBitRate:16e3,frameSize:4,duration:6e5})},initRecord:function(){var t=this;this.manager.onStart((function(e){console.log("录音开始"),t.inputStatus=!0})),this.manager.onStop((function(e){var n=t;console.log("录音结束：",e),n.inputStatus=!1,t.closeStatus||t.handleRecorder(e)})),this.manager.onError((function(e){t.aiSpeeking=!1,t.inputStatus=!0,console.log("call录音出错：",e.errMsg)})),this.manager.onFrameRecorded((function(e){var n=t,o=e.frameBuffer,a=new Int16Array(o),i=a.length,r=0;if(a.forEach((function(t){r+=t*t})),!(r<1e4)){var c=r/i,u=parseInt(10*Math.log10(c));console.log("db:",u),u<55?n.lowVoiceCount++:(n.lowVoiceCount=0,n.highVoiceCount++)}}))},userEnter:function(){var e=new Uint8Array(""),n=(new Date).getTime(),o=t.getStorageSync("openid")+n,a=this.stringToUint8Array(o+"@@@"+this.channelId+"@@@"+this.action),i=a.length+e.length,r=new Uint8Array(i),c=0;r.set(a,c),c+=a.length,r.set(e,c),this.sendMessage(r.buffer)},handleRecorder:function(e){var n=e.tempFilePath,a=(e.duration,this);o.getFileSystemManager().readFile({filePath:n,success:function(e){var n=e.data,o=new Uint8Array(n),i=(new Date).getTime(),r=t.getStorageSync("openid")+i,c=a.stringToUint8Array(r+"@@@"+a.channelId+"@@@"+a.action),u=c.length+o.length,s=new Uint8Array(u),l=0;s.set(c,l),l+=c.length,s.set(o,l),a.sendMessage(s.buffer)},fail:function(t){console.error("读取文件失败：",t)}})},stringToUint8Array:function(t){for(var e=unescape(encodeURIComponent(t)),n=e.length,o=new Uint8Array(n),a=0;a<n;a++)o[a]=e.charCodeAt(a);return o},sendMessage:function(e){var n=this,a=o.request({url:d,enableChunked:!0,header:{"content-type":"application/json","app-id":u.default.urls.appid,"open-id":t.getStorageSync("openid")?t.getStorageSync("openid"):"",address:encodeURIComponent(JSON.stringify(n.location)),Authorization:"bearer "+t.getStorageSync("token"),"Content-Type":"application/octet-stream"},responseType:"arraybuffer",method:"POST",data:e,success:function(t){console.log("接收完毕",n.result)},fail:function(t){console.error("request fail",t)}});a.onChunkReceived((function(t){console.log("接收数据:",t.data),n.aiSpeeking=!0,n.audioCtx.decodeAudioData(t.data,(function(t){n.index++,console.log("buffer:",t),n.result.push(t),1==n.index&&n.play()}),(function(t){console.error("decodeAudioData fail",t)}))}))},play:function(){var t=this,e=this.result.length;console.log("播放",this.currentPlayIndex,e);var n=this.audioCtx.createBufferSource();n.connect(this.audioCtx.destination),n.buffer=this.result[this.currentPlayIndex],t.currentPlayIndex==e&&(t.currentPlayIndex=0,t.aiSpeeking=!1,t.inputStatus=!0,t.result=[],n.end(),console.log("inputStatus:",t.inputStatus),console.log("aiSpeeking:",t.aiSpeeking)),n.start(),n.onended=function(){console.log("音频播放结束"),t.currentPlayIndex<e&&(t.currentPlayIndex++,t.play())}}}};e.default=h}).call(this,n("df3c")["default"],n("3223")["default"])},c698:function(t,e,n){"use strict";n.d(e,"b",(function(){return o})),n.d(e,"c",(function(){return a})),n.d(e,"a",(function(){}));var o=function(){var t=this.$createElement;this._self._c},a=[]},d637:function(t,e,n){"use strict";n.r(e);var o=n("c698"),a=n("09b8");for(var i in a)["default"].indexOf(i)<0&&function(t){n.d(e,t,(function(){return a[t]}))}(i);n("7274");var r=n("828b"),c=Object(r["a"])(a["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],void 0);e["default"]=c.exports}},[["8e53","common/runtime","common/vendor"]]]);