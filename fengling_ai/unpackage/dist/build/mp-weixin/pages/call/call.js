(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/call/call"],{"0aa2":function(e,t,n){"use strict";n.r(t);var o=n("8436"),a=n.n(o);for(var i in o)["default"].indexOf(i)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(i);t["default"]=a.a},"610f":function(e,t,n){"use strict";n.r(t);var o=n("735f"),a=n("0aa2");for(var i in a)["default"].indexOf(i)<0&&function(e){n.d(t,e,(function(){return a[e]}))}(i);n("e54c");var r=n("828b"),c=Object(r["a"])(a["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],void 0);t["default"]=c.exports},"735f":function(e,t,n){"use strict";n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return a})),n.d(t,"a",(function(){}));var o=function(){var e=this.$createElement;this._self._c},a=[]},8436:function(e,t,n){"use strict";(function(e,o){var a=n("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=a(n("7eb4")),r=a(n("7ca3")),c=a(n("ee10")),u=a(n("4d31")),s=n("8f59");function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}var f=u.default.urls.voiceUrl,d=getApp(),h={data:function(){return{imgUrl:d.globalData.baseImageUrl,inputStatus:!1,manager:e.getRecorderManager(),lowVoiceCount:0,audioCtx:o.createWebAudioContext(),currentPlayIndex:0,source:null,aiSpeeking:!0,index:0,result:[],tipsText:"请讲，正在听",closeStatus:!1,highVoiceCount:0,longTimeNoInput:!1,action:"audio_call_user_enter"}},onLoad:function(){var e=this;return(0,c.default)(i.default.mark((function t(){return i.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.userEnter(),e.initRecord();case 2:case"end":return t.stop()}}),t)})))()},onUnload:function(){this.close()},watch:{lowVoiceCount:function(e){e>30&&(this.highVoiceCount<20&&(this.longTimeNoInput=!0,this.action="audio_call_user_long_time_without_talking"),this.inputStatus=!1,this.manager.stop())},highVoiceCount:function(e){e>20&&(this.longTimeNoInput=!1)},inputStatus:function(e){e&&(this.resetData(),this.startRecord())}},computed:function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){(0,r.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},(0,s.mapState)(["answering","connected","connecting","canSend","inChannel","answerContinue","channelQaLen","channelId","channelQaList","location","token"])),methods:{close:function(){this.closeStatus=!0,this.manager.stop(),this.audioCtx&&(this.audioCtx.close(),this.audioCtx=null),e.navigateBack()},interrupt:function(){this.aiSpeeking&&(this.audioCtx.close(),this.resetData())},resetData:function(){this.highVoiceCount=0,this.longTimeNoInput=!1,this.action="",this.lowVoiceCount=0,this.index=0,this.result=[],this.aiSpeeking=!1,this.inputStatus=!0},startRecord:function(){this.manager.start({format:"PCM",sampleRate:8e3,numberOfChannels:2,encodeBitRate:16e3,frameSize:4,duration:6e5})},initRecord:function(){var e=this;this.manager.onStart((function(t){console.log("录音开始"),e.inputStatus=!0})),this.manager.onStop((function(t){var n=e;console.log("录音结束：",t),n.inputStatus=!1,e.closeStatus||e.handleRecorder(t)})),this.manager.onError((function(t){e.aiSpeeking=!1,e.inputStatus=!0,console.log("call录音出错：",t.errMsg)})),this.manager.onFrameRecorded((function(t){var n=e,o=t.frameBuffer,a=new Int16Array(o),i=a.length,r=0;if(a.forEach((function(e){r+=e*e})),!(r<1e4)){var c=r/i,u=parseInt(10*Math.log10(c));console.log("db:",u),u<55?n.lowVoiceCount++:(n.lowVoiceCount=0,n.highVoiceCount++)}}))},userEnter:function(){var t=new Uint8Array(""),n=(new Date).getTime(),o=e.getStorageSync("openid")+n,a=this.stringToUint8Array(o+"@@@"+this.channelId+"@@@"+this.action),i=a.length+t.length,r=new Uint8Array(i),c=0;r.set(a,c),c+=a.length,r.set(t,c),this.sendMessage(r.buffer)},handleRecorder:function(t){var n=t.tempFilePath,a=(t.duration,this);o.getFileSystemManager().readFile({filePath:n,success:function(t){var n=t.data,o=new Uint8Array(n),i=(new Date).getTime(),r=e.getStorageSync("openid")+i,c=a.stringToUint8Array(r+"@@@"+a.channelId+"@@@"+a.action),u=c.length+o.length,s=new Uint8Array(u),l=0;s.set(c,l),l+=c.length,s.set(o,l),a.sendMessage(s.buffer)},fail:function(e){console.error("读取文件失败：",e)}})},stringToUint8Array:function(e){for(var t=unescape(encodeURIComponent(e)),n=t.length,o=new Uint8Array(n),a=0;a<n;a++)o[a]=t.charCodeAt(a);return o},sendMessage:function(t){var n=this,a=o.request({url:f,enableChunked:!0,header:{"content-type":"application/json","app-id":u.default.urls.appid,"open-id":e.getStorageSync("openid")?e.getStorageSync("openid"):"",address:encodeURIComponent(JSON.stringify(n.location)),Authorization:"bearer "+e.getStorageSync("token"),"Content-Type":"application/octet-stream"},responseType:"arraybuffer",method:"POST",data:t,success:function(e){console.log("接收完毕",n.result)},fail:function(e){console.error("request fail",e)}});a.onChunkReceived((function(e){console.log("接收数据:",e.data),n.aiSpeeking=!0,n.audioCtx.decodeAudioData(e.data,(function(e){n.index++,console.log("buffer:",e),n.result.push(e),1==n.index&&n.play()}),(function(e){console.error("decodeAudioData fail",e)}))}))},play:function(){var e=this,t=this.result.length;console.log("播放",this.currentPlayIndex,t);var n=this.audioCtx.createBufferSource();n.connect(this.audioCtx.destination),n.buffer=this.result[this.currentPlayIndex],e.currentPlayIndex==t&&(e.currentPlayIndex=0,e.aiSpeeking=!1,e.inputStatus=!0,e.result=[],n.end(),console.log("inputStatus:",e.inputStatus),console.log("aiSpeeking:",e.aiSpeeking)),n.start(),n.onended=function(){console.log("音频播放结束"),e.currentPlayIndex<t&&(e.currentPlayIndex++,e.play())}}}};t.default=h}).call(this,n("df3c")["default"],n("3223")["default"])},ccda:function(e,t,n){"use strict";(function(e,t){var o=n("47a9");n("e58b");o(n("3240"));var a=o(n("610f"));e.__webpack_require_UNI_MP_PLUGIN__=n,t(a.default)}).call(this,n("3223")["default"],n("df3c")["createPage"])},e54c:function(e,t,n){"use strict";var o=n("eb9f"),a=n.n(o);a.a},eb9f:function(e,t,n){}},[["ccda","common/runtime","common/vendor"]]]);