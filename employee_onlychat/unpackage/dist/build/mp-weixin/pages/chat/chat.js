(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/chat"],{"1b0e":function(e,t,n){"use strict";(function(e,o){var i=n("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s=i(n("7eb4")),c=i(n("ee10")),a=i(n("f3b0")),r=(i(n("7675")),requirePlugin("WechatSI")),l=r.getRecordRecognitionManager(),h=getApp(),u={data:function(){return{showLogin:!1,historyId:0,loadAllHistory:!1,showReAuth:!1,imgUrl:h.globalData.baseImageUrl,scrollView:"",gender:[{value:"male",text:"男"},{value:"female",text:"女"}],currentGender:0,age:"",ques:"",hold:"h1",qaList:[],socketOpen:!1,socketMsgQueue:[],answerMsg:"",canSend:!0,placeHolder:"想了解什么工作，请告诉我吧",qaListLen:0,historyList:[],appInfo:{},scroll:0,chatShareId:0,timeShareId:0,header:{},sid:0,connected:!1,connecting:!1,socketTask:!1,num:1,curStrIndex:0,curText:"",marginTop:h.globalData.marginTop,tabMargin:h.globalData.tabMargin,scrollHeight:0,scrollHeight2:0,subTabHeight:h.globalData.subTabHeight,showVoice:!1,showRecord:!0,showChat:!1,showFullScreen:!0,showWanner:!1,cityData:[],city1:"",city2:"",city3:"",cityArr:[],typeTags:[],seleTypeIds:[],selectType:[],open_id:"",getPhoneData:{},showInputing:!1,recordContent:"",enableSpeeking:!1,timer:null,currentSiging:{},showSetting:!1,openid:"",startPoint:{},cancelRecord:!1,titleHeight:0,showAnswering:!1,inputHeight:0,recordSecond:0,secondText:"00:00",secondTimer:null,cancelIconLeft:0,cancelIconRight:0,cancelIconBottom:0,cancelIconTop:0}},onShareAppMessage:function(){return{title:"风铃AI",content:"海量岗位，等你来",path:"/pages/index/index",imageUrl:h.globalData.baseImageUrl+"/worker/logo.png"}},onShareTimeline:function(){return{title:"风铃AI",content:"海量岗位，等你来",path:"/pages/index/index",imageUrl:h.globalData.baseImageUrl+"/worker/logo.png"}},onLoad:function(t){var n=this;return(0,c.default)(s.default.mark((function t(){var o;return s.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n,n.scrollHeight=h.globalData.systemHeight-4*n.tabMargin-n.subTabHeight-n.marginTop,n.scrollHeight2=h.globalData.systemHeight-1*n.subTabHeight,t.next=5,n.getOpenId();case 5:n.openid=t.sent,o=e.getMenuButtonBoundingClientRect(),n.titleHeight=o.height,e.onKeyboardHeightChange((function(e){console.log(e.height,"键盘高度变化"),0==e.height&&(n.inputHeight=0)})),n.getHistory(),n.showAichat();case 11:case"end":return t.stop()}}),t)})))()},onUnload:function(){this.close()},mounted:function(){},methods:{getOpenId:function(){var t=this;return new Promise((function(n){e.login({success:function(o){if(console.log(o,"dyres"),"login:ok"==o.errMsg){var i={code:o.code};"/auth/worker/wechat/mini/openid",t.$request("/auth/worker/wechat/mini/openid",i,"POST").then((function(t){0==t.code&&(e.setStorage({key:"openid",data:t.data.open_id}),n(t.data.open_id))}))}},fail:function(e){console.log(e,"接口调用失败")}})}))},getIconPosition:function(){var t=this,n=e.createSelectorQuery().in(t);n.select(".cancel_icon").boundingClientRect((function(e){console.log("querydata",e),e&&(console.log("元素的位置信息：",e),t.cancelIconTop=e.top,t.cancelIconBottom=e.top+e.width,t.cancelIconLeft=e.left,t.cancelIconRight=e.right)})).exec()},keyboardHeightChange:function(e){console.log(e,"键盘")},inputBindFocus:function(e){e.detail.height&&(this.inputHeight=e.detail.height)},startCount:function(){var t=this;this.secondTimer=setInterval((function(){t.recordSecond<60?(t.recordSecond++,t.recordSecond<10?t.secondText="00:0"+t.recordSecond:t.secondText="00:"+t.recordSecond):(clearInterval(t.secondTimer),e.showToast({title:"最多发送60s",duration:3e3,icon:"none"}),t.stopRecord())}),1e3)},handleTouchMove:function(e){var t=e.touches[e.touches.length-1].clientX>this.cancelIconLeft&&e.touches[e.touches.length-1].clientX<this.cancelIconRight,n=e.touches[e.touches.length-1].clientY>this.cancelIconTop&&e.touches[e.touches.length-1].clientY<this.cancelIconBottom;this.cancelRecord=!(!t||!n)},back:function(){e.navigateBack()},closeLogin:function(){this.showLogin=!1},openSetting:function(){var t=this;e.openSetting({success:function(e){console.log(e.authSetting,"res.authSetting"),e.authSetting["scope.record"]&&(t.showSetting=!1)},fail:function(e){console.log(e,"openerr")},complete:function(){this.showReAuth=!1}})},initRecord:function(){var t=this;l.onStart=function(e){t.recordContent="",t.showInputing=!0,t.startCount(),t.getIconPosition()},l.onRecognize=function(e){t.recordContent+=e.result},l.onStop=function(n){e.hideLoading(),t.recordContent+=n.result,t.showInputing=!1;var o={content:t.recordContent,origin:"customer"};console.log(o),console.log(t.cancelRecord),t.recordSecond=0,t.secondText="00:00",clearInterval(t.secondTimer),t.cancelRecord?t.cancelRecord=!1:t.send(o)},l.onError=function(n){console.log(n,"err"),t.cancelRecord=!1,t.showInputing=!1,t.recordSecond=0,t.secondText="00:00",clearInterval(t.secondTimer),e.hideLoading();switch(n.retcode){case-30003:"未获取到录音数据，请尽可能提高音量。";break;case-30006:"录音识别超时，请重试。";break;case-30008:"网络链接失败，请重试。";break;case-30004:"未识别到结果，请尽可能提高音量。";break;case-40001:"达到接口调用频率限制，请联系管理员。";break;default:"录音功能出错，请联系管理员。";break}}},startRecord:function(e){this.startPoint=e.touches[0],this.showInputing=!0,this.cancelRecord=!1,l.start({duration:6e4,lang:"zh_CN"})},stopRecord:function(){clearInterval(this.secondTimer),this.showInputing=!1,this.cancelRecord||e.showLoading({title:"正在取消"}),l.stop()},chooseWork:function(e,t){console.log(e,t)},showAichat:function(){var t=this;return(0,c.default)(s.default.mark((function n(){var o;return s.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return t.historyId=0,t.historyList=[],t.loadAllHistory=!1,t.qaList=[],o=t,e.authorize({scope:"scope.record",success:function(e){console.log(e,"success")},fail:function(e){o.showSetting=!0,console.log(e,"err")}}),n.next=8,t.getHistory();case 8:t.historyList=n.sent,t.toScroll(),t.creatConnect(),t.initRecord(),t.showChat=!0;case 13:case"end":return n.stop()}}),n)})))()},openSeepking:function(){this.enableSpeeking=!this.enableSpeeking},closeAichat:function(){this.showChat=!1,this.historyId=0,this.enableSpeeking=!1,o.stopBackgroundAudio(),this.close()},toInput:function(){this.showRecord=!1},toVoice:function(){this.showRecord=!0},doSend:function(e,t){e.ctrlKey&&13===e.keyCode?this.ques+="\n":void 0!==e&&(this.sendQuestion(),e.preventDefault())},getLocation:function(){var t=this;e.getLocation({success:function(e){t.reverseGeocodingClick(e.latitude,e.longitude)},fail:function(e){console.error("定位失败",e)}})},legal:function(){this.age&&(Number(this.age)||e.showModal({title:"输入不合法，请输入大于18的数字。",showCancel:!1}))},getHistory:function(){var e=this;return new Promise((function(t){var n="/ai/chat/histories?id="+e.historyId;e.$request(n).then((function(n){if(0==n.code){var o=n.data.reverse(),i=n.data.length;i>0&&(e.historyId=n.data[0].id),t(o)}}))}))},getMoreHistory:function(){var t=this;if(this.loadAllHistory)e.showToast({title:"已加载全部",icon:"none",duration:2e3});else{var n="/ai/chat/histories?id="+this.historyId;this.$request(n).then((function(e){if(0==e.code){t.historyList=e.data.reverse().concat(t.historyList);var n=e.data.length;n>0?t.historyId=e.data[0].id:t.loadAllHistory=!0}}))}},toScroll:function(){var e=this;this.$nextTick((function(){if(console.log(123),0==e.qaList.length){var t=e.historyList.length-1;t>=0&&(e.scrollView="his"+t)}else{var n=e.qaList.length-1;e.scrollView="qa"+n}console.log(e.scrollView,"scrollView")}))},getDetail:function(e){var t={content:e,origin:"customer"};this.send(t)},sendQuestion:function(){if(this.curStrIndex=0,this.ques){if(this.inputHeight=0,this.canSend){this.canSend=!1;var t={content:this.ques,origin:"customer"};this.send(t)}}else e.showToast({icon:"none",title:"想了解什么工作，请告诉我吧"})},genderChange:function(e){for(var t=0;t<this.gender.length;t++)this.gender[t].value==e.detail.value&&(this.currentGender=t)},onchange1:function(t){t.detail.value.length&&this.hasSimpleCity(t.detail.value[1].value)?e.showToast({title:"该城市已选择",icon:"error",duration:2e3}):this.cityArr[0]=t.detail.value},onchange2:function(t){t.detail.value.length&&this.hasSimpleCity(t.detail.value[1].value)?e.showToast({title:"该城市已选择",icon:"error",duration:2e3}):this.cityArr[1]=t.detail.value},onchange3:function(t){t.detail.value.length&&this.hasSimpleCity(t.detail.value[1].value)?e.showToast({title:"该城市已选择",icon:"error",duration:2e3}):this.cityArr[2]=t.detail.value},sureCity:function(){for(var e=this.cityArr.filter((function(e){return e.length>0})),t="",n=e.length,o=0;o<n;o++)t+=e[o][1].text+"、";return t=t.slice(0,t.length-1),t},hasSimpleCity:function(e){for(var t=this.cityArr.length,n=!1,o=0;o<t;o++)this.cityArr[o]&&this.cityArr[o].length>0&&e==this.cityArr[o][1].value&&(n=!0);return n},getCitys:function(){var e=this;this.$request("/common/areas").then((function(t){0==t.code&&(e.cityData=t.data)}))},creatConnect:function(){if(this.connected||this.connecting)return!1;this.connecting=!0,console.log(h.globalData.wssUrl,"wss"),this.socketTask=e.connectSocket({url:h.globalData.wssUrl,header:{"content-type":"application/json","app-id":a.default.urls.appid,"open-id":e.getStorageSync("openid")},method:"GET",success:function(e){},fail:function(e){}}),this.connect(),console.log(this.socketTask,"socketTask")},toSign:function(t){var n=this;this.currentSiging=t,this.isLogin()?e.showModal({title:"正在报名",success:function(e){e.confirm&&n.sureSign(t.content.id)}}):n.showLogin=!0},sureSign:function(t){var n=this,o="/worker/accept/project/"+t;this.$request(o,{},"POST").then(function(){var t=(0,c.default)(s.default.mark((function t(o){return s.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:0==o.code&&(e.showToast({title:"报名成功",duration:3e3}),n.signed=!0,n.closeLogin());case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())},connect:function(){var t=this,n=this;this.socketTask.onOpen((function(e){t.connecting=!1,t.connected=!0,t.noInput(),console.log("onOpen",e)})),this.socketTask.onError((function(n){t.connecting=!1,t.connected=!1,t.canSend=!0,e.hideLoading(),console.log("onError",n),t.creatConnect()})),this.socketTask.onMessage((function(o){var i=JSON.parse(o.data);e.hideLoading(),n.showAnswering=!1,console.log(i,"respone"),0==i.code?(n.toScroll(),n.enableSpeeking&&"pong"!=i.data.content&&n.formatResultStr(i.data.content),"pong"!=i.data.content&&n.qaList.push({content:i.data.content,source:"system"})):e.showModal({title:i.msg}),t.resetData()})),this.socketTask.onClose((function(o){e.hideLoading(),t.connected=!1,t.socketTask=!1,console.log("onClose",o),clearInterval(n.timer),t.creatConnect()})),console.log("task",this.socketTask)},resetData:function(){this.canSend=!0,this.placeHolder="想了解什么工作，请告诉我吧",this.cancelRecord=!1},noInput:function(){var e=this;this.timer=setInterval((function(){e.send({content:"ping",origin:"customer"})}),1e4)},formatResultStr:function(e){e&&this.speeking(e)},speeking:function(e){console.log(e,"播报内容"),r.textToSpeech({lang:"zh_CN",content:e,success:function(e){0==e.retcode?(console.log("result",e.result),o.playBackgroundAudio({dataUrl:e.filename,title:""})):console.warn("翻译失败",e)},fail:function(e){console.log("网络失败",e)}})},send:function(e){var t=this;this.socketTask.send({data:JSON.stringify(e),success:function(n){t.showAnswering=!0,console.log(e,"data"),"ping"!=e.content&&(t.qaList.push(e),t.num++,t.hold="h"+t.num,t.toScroll(),t.ques="",t.placeHolder="正在回答中，请稍后...",t.qaListLen=t.qaList.length)},fail:function(e){console.log(e)}})},close:function(){this.socketTask&&this.socketTask.close&&this.socketTask.close()},dislike:function(e){console.log(e,"content");this.send({origin:"customer",content:"不喜欢",type:"str"})},cancel:function(){this.showWanner=!1,this.toScroll()},formatCity:function(){console.log(this.cityArr);for(var e=this.cityArr.length,t=[],n=0;n<e;n++){var o=[];if(this.cityArr[n]&&this.cityArr[n].length)for(var i=0;i<this.cityArr[n].length;i++){var s={id:"",name:""};s.id=this.cityArr[n][i].value,s.name=this.cityArr[n][i].text,o.push(JSON.parse(JSON.stringify(s)))}o.length&&t.push(JSON.parse(JSON.stringify(o)))}return t},deFormatCity:function(e){for(var t=e.length,n=[],o=0;o<t;o++){var i=o+1,s="city"+i;this[s]=e[o][1].id;for(var c=[],a=0;a<e[o].length;a++){var r={value:"",text:""};r.value=e[o][a].id,r.text=e[o][a].name,c.push(JSON.parse(JSON.stringify(r)))}n.push(JSON.parse(JSON.stringify(c)))}return n},finishSele:function(){var t=this;console.log(this.selectType,"selectType");var n=this.gender[this.currentGender].text+","+this.age+",";n+="\n"+this.sureCity();var o=this.selectType.length;n+="\n";for(var i=0;i<o;i++)for(var s=0;s<this.selectType[i].tags.length;s++)n+=this.selectType[i].tags[s].name+"/";var c=this.formatCity(this.cityArr),a={age:Number(this.age),gender:this.gender[this.currentGender].text,areas:c,type_tags:this.selectType,all_ags:this.typeTags};this.$request("/ai/resume",a,"POST").then((function(o){if(0==o.code){e.showToast({title:"保存成功",duration:2e3}),t.showWanner=!1;var i={content:n,origin:"customer"};t.send(i)}}))},addWanner:function(){var e=this,t=this;this.$request("/ai/resume").then((function(n){if(0==n.code){e.typeTags=n.data.all_tags,e.selectType=n.data.type_tags?n.data.type_tags:[],console.log(e.selectType,"selectType");for(var o=0;o<e.selectType.length;o++)for(var i=0;i<t.selectType[o].tags.length;i++)t.seleTypeIds.push(t.selectType[o].tags[i].id);e.showWanner=!0,e.age=n.data.age?n.data.age:"";for(var s=0;s<e.gender.length;s++)e.gender[s].text==n.data.gender&&(e.currentGender=s);e.cityArr=n.data.areas?e.deFormatCity(n.data.areas):[];for(var c=0;c<e.cityArr.length;c++){var a=c+1,r="city"+a;e[r]=e.cityArr[c][1].value}}}))},chooseTag:function(e,t){console.log(e,t,"item&tag");var n=JSON.parse(JSON.stringify(e));n.tags=[];for(var o=!1,i=0,s=this.selectType.length,c=0;c<s;c++)n.id==this.selectType[c].id&&(o=!0,i=c);if(o){var a=this.selectType[i].tags.filter((function(e){return e.id==t.id}));"[]"==JSON.stringify(a)?this.selectType[i].tags.push(t):a.length>0&&(this.selectType[i].tags=this.selectType[i].tags.filter((function(e){return e.id!=t.id})))}else n.tags.push(t),this.selectType.push(JSON.parse(JSON.stringify(n)));console.log(this.seleTypeIds,this.seleTypeIds.indexOf(t.id)),-1!=this.seleTypeIds.indexOf(t.id)?this.seleTypeIds.splice(this.seleTypeIds.indexOf(t.id),1):this.seleTypeIds.push(t.id),this.selectType=this.selectType.filter((function(e){return"[]"!=JSON.stringify(e.tags)}))},noPosition:function(){this.showReAuth=!1}}};t.default=u}).call(this,n("df3c")["default"],n("3223")["default"])},5168:function(e,t,n){"use strict";n.r(t);var o=n("f413"),i=n("a3db");for(var s in i)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return i[e]}))}(s);n("a22b");var c=n("828b"),a=Object(c["a"])(i["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],void 0);t["default"]=a.exports},a22b:function(e,t,n){"use strict";var o=n("d3e8"),i=n.n(o);i.a},a3db:function(e,t,n){"use strict";n.r(t);var o=n("1b0e"),i=n.n(o);for(var s in o)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(s);t["default"]=i.a},b4fa:function(e,t,n){"use strict";(function(e,t){var o=n("47a9");n("ad3b");o(n("3240"));var i=o(n("5168"));e.__webpack_require_UNI_MP_PLUGIN__=n,t(i.default)}).call(this,n("3223")["default"],n("df3c")["createPage"])},d3e8:function(e,t,n){},f413:function(e,t,n){"use strict";n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return i})),n.d(t,"a",(function(){}));var o=function(){var e=this,t=e.$createElement,n=(e._self._c,e.showWanner||e.showReAuth?null:e.__map(e.historyList,(function(t,n){var o=e.__get_orig(t),i=t.content.replace(/\\n/g,"\n");return{$orig:o,g0:i}}))),o=e.showWanner||e.showReAuth?null:e.__map(e.qaList,(function(t,n){var o=e.__get_orig(t),i=t.content.replace(/\\n/g,"\n");return{$orig:o,g1:i}}));e.$mp.data=Object.assign({},{$root:{l0:n,l1:o}})},i=[]}},[["b4fa","common/runtime","common/vendor"]]]);